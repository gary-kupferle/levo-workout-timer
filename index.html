<!DOCTYPE html>
<!-- saved from url=(0047)http://mdn.github.io/beginner-html-site-styled/ -->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <title>CrossFit Levo Workout Timer</title>
    <link href="css/css.css" rel="stylesheet" type="text/css">
    <link href="./css/style.css" rel="stylesheet" type="text/css">
</head>
<body>
<div>
    <img src="./images/levo-logo.png" alt="CrossFit Levo Logo" width="25%" height="25%" align="right">
    <h2>Raising Bars, Lifting Spirits</h2>
</div>
<div>
    <div>
        <div class="round-display" style="float:left">
            <label class="display-label" for="rounds">Rounds</label>
            <input type="number" id="rounds" value="1" min="0" step="1"/>
        </div>
        <div class="time-display" style="float:left">
            <label class="display-label" for="minutes">Minutes</label>
            <input type="number" id="minutes" value="0" min="0" max="60"/>
        </div>
        <div class="colon-display" style="float:left">
            <label>:</label>
        </div>
        <div class="time-display" style="float:left;margin-right: 50px;">
            <label class="display-label" for="seconds">Seconds</label>
            <input type="number" id="seconds" value="0" min="0" max="60"/>
        </div>
    </div>
    <div style="float:left;margin-right: 425px;">
        <button onclick="runIntervalTimer()" type="button" class="button">Start</button>
    </div>
    <div id="restBetweenRounds">
        <div class="display" style="float:left">
            <label class="display-label">Rest Between Rounds</label>
        </div>
        <div class="display" style="float:left">
            <label class="display-label" for="restMinutes">Minutes</label>
            <input type="number" id="restMinutes" value="0" min="0" max="60"/>
        </div>
        <div class="display" style="float:left;margin-right: 100px;">
            <label class="display-label" for="restSeconds">Seconds</label>
            <input type="number" id="restSeconds" value="0" min="0" max="60"/>
        </div>
    </div>
</div>

<audio id="audio-alarm">
    <source src="audio/alert.mp3" type="audio/mp3">
    Your browser does not support the audio element.
</audio>


<script>
  let audioAlarm = document.getElementById("audio-alarm");

  function playAudio() {
    audioAlarm.play();
  }

  function setupNewRound(minutes, minutesPerRound, seconds, secondsPerRound, rounds, timerState) {
    minutes.value = minutesPerRound;
    seconds.value = secondsPerRound;
    rounds.value = rounds.value - 1;

    let countdownAmount = (1000 * 60 * minutesPerRound) + (1000 * secondsPerRound) + 1000;
    let now = new Date().getTime();
    timerState.countdownTo = now + countdownAmount;
    timerState.inRestPeriod = false;

    console.log("setupNewRound -- timerState.inRestPeriod = " + timerState.inRestPeriod);
  }

  function completeTimer(timerInterval, minutes, minutesPerRound, seconds, secondsPerRound, rounds) {
    clearInterval(timerInterval);
    minutes.value = minutesPerRound;
    seconds.value = secondsPerRound;
    rounds.value = rounds.value - 1;
  }


  function setupNewRestPeriod(restMinutes, minutesPerRest, restSeconds, secondsPerRest, timerState) {

    restMinutes.value = minutesPerRest;
    restSeconds.value = secondsPerRest;

    let countdownAmount = (1000 * 60 * minutesPerRest) + (1000 * secondsPerRest) + 1000;
    let now = new Date().getTime();
    timerState.countdownTo = now + countdownAmount;
    timerState.inRestPeriod = true;
    console.log("setupNewRestPeriod -- timerState.inRestPeriod = " + timerState.inRestPeriod);
    console.log("setupNewRestPeriod -- timerState.countdownTo = " + timerState.countdownTo);
  }

  function isRoundValueValid(rounds) {
    if (rounds.value <= 0) {
      rounds.style.color = "red";
      return false;
    }
    rounds.value = parseInt(rounds.value);
    rounds.style.color = "007acc";
    return true;
  }

  function validateMinuteSecondFields(minute, second) {
    if (minute.value <= 0 && second.value <= 0) {
      minute.style.color = "red";
      second.style.color = "red";
      return false;
    }

    minute.value = parseInt(minute.value);
    second.value = parseInt(second.value);
    minute.style.color = "black";
    second.style.color = "black";
    return true;
  }


  function runIntervalTimer() {
    const rounds = document.getElementById("rounds");
    const minutes = document.getElementById("minutes");
    const seconds = document.getElementById("seconds");
    const restMinutes = document.getElementById("restMinutes");
    const restSeconds = document.getElementById("restSeconds");

    const minutesPerRound = minutes.value;
    const secondsPerRound = seconds.value;
    const restMinutesPerRound = restMinutes.value;
    const restSecondsPerRound = restSeconds.value;

    if (!isRoundValueValid(rounds) |
        !validateMinuteSecondFields(minutes, seconds)) {
      return;
    }

    if (restMinutesPerRound == 0 && restSecondsPerRound == 0) {
      const restBetweenRounds = document.getElementById("restBetweenRounds");
      restBetweenRounds.style.display = "none";
    }

    let countdownAmount = (1000 * 60 * minutes.value) + (1000 * seconds.value) + 1000;
    let now = new Date().getTime();
    let timerState = {inRestPeriod: false, countdownTo: now + countdownAmount};

    // Update the count down every 0.1 second
    let timerInterval = setInterval(function () {
      now = new Date().getTime();

      // Find the distance between now and the count down date
      let distance = timerState.countdownTo - now;

      // Time calculations for days, hours, minutes and seconds
      if (!timerState.inRestPeriod) {
        minutes.value = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)).toString();
        seconds.value = Math.floor((distance % (1000 * 60)) / 1000).toString();
      } else {
        restMinutes.value = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)).toString();
        restSeconds.value = Math.floor((distance % (1000 * 60)) / 1000).toString();
      }

      // If the count down is over
      if (distance < 1050) {
        playAudio();
        if (!timerState.inRestPeriod && rounds.value > 1) {
          console.log("countdownAmount " + countdownAmount.toString());
          if (restMinutesPerRound > 0 || restSecondsPerRound > 0) {
            setupNewRestPeriod(restMinutes, restMinutesPerRound, restSeconds, restSecondsPerRound, timerState);
            minutes.value = 0;
            seconds.value = 0;
          } else {
            setupNewRound(minutes, minutesPerRound, seconds, secondsPerRound, rounds, timerState);
            restMinutes.value = 0;
            restSeconds.value = 0;
          }
          console.log("runInterval/if -- timerState.inRestPeriod = " + timerState.inRestPeriod);
        } else if (timerState.inRestPeriod) {
          setupNewRound(minutes, minutesPerRound, seconds, secondsPerRound, rounds, timerState);
          restMinutes.value = 0;
          restSeconds.value = 0;
          timerState.inRestPeriod = false;

        } else if (rounds.value <= 1) {
          completeTimer(timerInterval, restMinutes, minutesPerRound, seconds, secondsPerRound, rounds);
        }
      }
    }, 100);
  }


  function runRestTimer() {
    const restMinutesPerRound = restMinutes.value;
    const restSecondsPerRound = restSeconds.value;

    let countdownAmount = (1000 * 60 * restMinutesPerRound) + (1000 * restSecondsPerRound) + 1000;
    let now = new Date().getTime();
    let countdownTo = now + countdownAmount;

    // Update the count down every 0.1 second
    let restTimerInterval = setInterval(function () {
      let now = new Date().getTime();

      // Find the distance between now and the count down date
      let distance = countdownTo - now;

      // Time calculations for days, hours, minutes and seconds
      restMinutes.value = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)).toString();
      restSeconds.value = Math.floor((distance % (1000 * 60)) / 1000).toString();

      // If the count down is over, write some text
      if (distance < 1050) {
        playAudio();
        clearInterval(restTimerInterval);
        restMinutes.value = restMinutesPerRound;
        restSeconds.value = restSecondsPerRound;
      }
    }, 100);
  }
</script>

</body>
</html>